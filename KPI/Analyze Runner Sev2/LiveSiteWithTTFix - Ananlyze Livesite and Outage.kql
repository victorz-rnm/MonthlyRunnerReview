https://dataexplorer.azure.com/clusters/aznwsdn/databases/aznwmds?query=H4sIAAAAAAAAA%2B1Ye3PbNhL%2FX58CdTsV1dJ6WA%2FbSZwZR7YbzViOaitJZxKfBiYhCjUJsABoW71rP3sXAJ%2BinDjXu7nr3GnGJrhY%2FHaxu9hdMCQKhZzfvsLe7TxCRwgH3OkddP3W80YIc3NBo9cqCsecKcIUMDhSiWfwR1nQavy9geCnGaUicQ%2BmBYlD7BFnp7njIvMvpyBN0f9gdQvw9dJOB13aeSQjLBT6JeGKSISZjxhnuzeC4FsQhWQMPLIibq8s7lt2I%2BPnhQTQpi7i9Xx6vgUWwc6oWlfA%2BxVwHFnsb1PsvTo2sBAhtd5b0AYVNL1HA%2FdxJ8Xr1%2FGMIbZhDStYoUV6kQIN6kAhkXJXrTDbBjaqgAUW7GUKNqyDBWA4RcSjePsVvK%2F7h8%2BzMDDStngdvBB%2BYrcHZcAXH%2F728vo7rV5muP0yYsTvUh8rHFRj5bAC89XurkHa3S1jHWzH8ngUgWJVvF63DPjxo%2Fy%2BHHqHBdIFFxEO6a8ERUmoaAx7vV9RCHETz0hxhDMbGJJZZyU0frNnMCBqwjzqgxLnlN3qM0jT9y0HMbQsMOFh5eyslIrls04n5kLhsB1RT3DJl4p6URt21qFR3LnrdzJA2fGJwjSUHdhKRoSddVY8IjvptrSIknLgSkzFRJEoU%2B%2Bei1v9PvGfrqBP7tr410QQo1YkzbjzhpHOQsOBySLZIT5VWrNCwHaVrmBbIZkTHF3giGiVGDyfoS15Kw4pmFXq1GbGhlOfzY%2F5doFNEAnuAx5Klw4WAq8XIWGBWjk5QAu9RD23APzQu3aRBkthLESm5E%2BUrTHTGk58Cbj%2BGlip53xo9rrDwWHTRTAYjXp6MNrv9wd6cLB30NvTg8He6LCrB%2FvDw75hHh2MDoZ21XBwMLCjwb4hHfaHg3623gxG3d7IDHq9weDAIPX6w26%2F37xOEz8OwxOsMGjmhQnEo3CamacgdHyYErztQXAIDPPtW%2BDh7XvKfH4v24yoZqutmW6wJE5zDEeIMyD9QNRi4kWLLJ7l4j1Vq%2Fn8ofEPOBZEEDTlPl1S4oNwAgYtalPO8eaegQ%2Bt5SBEkVMxZcuUDipJFKu1g2ZYgJhMHISLmb4id0RApkEvjtBeA2IPlFM63MPEJ0itCJqMp%2FDECq2wRDE4HFbnGmRw83UMsfU7ap7TO3IFEdpEXKCJfJNA%2FiHHnkpwiI6OUA9W%2BhARIEChQhcXzakKIdbGJqnqHbuV%2FbsVSW5p5xcmRrN3hpkqU3Sxxp46DimWLrLHc8wTfZDTl5BL4qek%2BfxE%2F7vQ%2F05ZoB9n9EE%2Fpm5uKRglN9ITNFaUs3TlRB4nip8QRTxFfHdj5y6acakiyDskSjdaEK4UVgkolz1fYzmXWjYkbg101R91L0mIDa5%2B0amlkGBjFJw0OdGHJw1WMLNMImgjdLq9WZdM%2FbxRsJAH6GT8ktEBQHEIVqJoRJylTthqkb%2BXndNcw293Ot31%2FWarVWBlaqX5IY%2B%2BjN5y0RKHkrhlymacbF9qZ%2BsAOd1abnO5pcJ01y3GFbPWBZYm7cJNUtXfdYDybIZQoRUWMzG2iWCIdmE2NCFZ5wNixmeHEKx1rmnGMy1Jhux1XqlAzSeVyOGWEglpU3FbUpxSioE46dg4XDe14Fjwn8m%2F8uSD7rUa51RZWv%2BL2SF1LZj8Zw6FARp8%2FygkS8UTqF%2BmBq8oU22WRAtI6dBqgrLyaNi1ZHAkAAbrI7lKlkvoxxy9Ymv5S2mfqXoTb6pTznsoQSueSAKTmVfHemF0Rknon0IJpenNZrPApAXO5jlbuh6teylAkQC%2FaK9YBIsIPzjVIPyuVU2jLtKB9Ock2d9YE7lYQyhrsfrg2siGajqRMiEZA5yxd9Bh6OQLKRdV9Wm0GpyV3%2F89ni88%2FlT%2FyiuGY7ni6t3eUx37eMuSImxLI5ecqzEG2fplyhlVXJj0IgP9qB%2F4%2FzqL5TuQ2Y1pCaogAWTkaXot2j4VqiV7bFitYqnL8bHJORB9ae4Bygnck7MUpieqXz4cmM5mTSk0YP6r9RhuwgGxdi2L%2F08bNvPxqyTITQtVw1ydkL5NPSEwv8j25bg8hVorGA5zNxQQxW1RmsN%2FSxaSKKdYsQH2qegvoLbEdd6bTanUN2xwsW0RkKN4yO%2FBnLa%2BtNBXR6gJ1zMe3hG%2FaXqGcidR8ip4Hq543VarKNBpM7FxSS%2F3A3DBKLTJCkCIpd6%2Fp91nXGwDUl83do5j%2BpaRh9gUzjNoNeAmLOHW2xxfzo5nE9BwY8HF5exHbjjsaCvTB5i4hpItoGajK9ACnQoB95VL3QK%2FpsHqesfdESSAeAyhrocWcQPknAfUw%2BEJlbdojM4EIVfmC9oY2gA9ob%2BC6Ml0ZWXte1snz%2FCNoN4si%2F0Tfs9A8MY7Kv9KGDnbjwkXSXTOpcw6jAnTe6MesQI%2BiVlCPKE4YNB5UE%2FOBPdhWY1SWYB2dJ8I%2FlxBSGhwWKEpBX4JfOpHxoz5oOZqsLeeT58bks7fTU5mROhr9mJ%2FCGzQjoK5c1ll7x5fTq%2BRIL8kRCr9XUl7AmgQCnWpECUIcJemUyMiDZzx7G09ak4f4pB6VKFz7t1qTdNnTYHLhDEDVYw2fmVtLY%2B%2BZR8HAQQdNll3PKuvb76B%2B7howiFCPlli%2FRXmTjcECA4yI1RPIo8z3zgaqiiKiALmxxrvomUtH9dSI19KKibPF9mj3sJmdaRWP%2BoF4i9x2f98E%2F9PNO3Vdr3o1rMO7zNdzPZC%2BoVFtFEpogFh5A5XCqglrQgO1QqiaUkDCfOpLmNDyFq6St2kknGVNm4p9w8J9euV88%2Bon1XdcyzV29gvhU8u0EWRfVmYL466hJZmGy0EZ%2BMbLb6d21d%2FmfpGQN7PaYb10VJlS2Kx3YrAqny3xpxLbVU8nB7u8reUdDa952qcqiK6VttVblVFc0P4%2F6n%2Fa5769MKy4dBSpJTC4g8B48OBtBwAAA%3D%3D

let lookBackTm = ago(180d);
let TrimHtmlContent = (str:string)
{
    let step1 = replace("'", "'", replace(" ", " ", str));
    // Replace smart quotes and non-breaking spaces
    let step2 = replace("&nbsp;", " ", step1);
    // Replace HTML non-breaking space entity
    let step3 = replace("&amp;", "&", step2);
    // Replace ampersand entity
    let step4 = replace("&quot;", "\"", step3);
    // Replace quote entity
    let step5 = replace("&lt;", "<", step4);
    // Replace less-than entity
    let step6 = replace("&gt;", ">", step5);
    // Replace greater-than entity
    let step7 = replace("&#39;", "'", step6);
    // Replace single quote entity
    let step8 = replace("<[^>]*>", "", step7);
    // Remove HTML tags
    let step9 = replace("<!--[^>]*-->", "", step8);
    // Remove HTML comments
    let step10 = replace("\\s+", " ", step9);
    // Normalize multiple whitespaces to a single space
    step10
};
let getIncidentLink = (incident:string)
{
    let link = strcat("https://portal.microsofticm.com/imp/v3/incidents/details/", incident, "/home");
    link
};
let getRepairItemLink = (workItemId:string)
{
    let link = strcat("https://dev.azure.com/msazure/One/_workitems/edit/", workItemId);
    link
};
let getSimpleTeamName = (name: string)
{
    let splitList = split(name, "\\");
    let result = iif(array_length(splitList) > 1, splitList[1], name);
    result
};
let XinyanTeamIds = dynamic(['10549', '10661', '67334', '82812', '42690', '75939', '68685', '105484', '10475', '93543', '82813', '60163', '114480', '135033']);
let allData = cluster('https://icmdataro.centralus.kusto.windows.net').database('Common').Get_Icm_Incidents_WithTTx
| where ModifiedDate > lookBackTm
| where OwningTeamId in (XinyanTeamIds) and isempty( ParentIncidentId) and Severity <= 2
//don't include the ICM that has parrent
| where IncidentType =~ 'LiveSite' or IsOutageActual == 1
| distinct IncidentId, Title, CreateDate, ModifiedDate, IncidentType, OwningTeamName, OwningTenantName, OwningContactAlias, RepairCount, RepairClosedCount, TTD, TTN, TTEng, TTFix, TTM, Severity, SubscriptionCount, IsAutoDetected, IsOutageActual, PostmortemTitle, PostmortemStatus, Status, HasTsg, Tags, IsS360Related, S360Link, IsOutage;
let ICMIDs = allData
| summarize by IncidentId;
allData
| extend CreateDate = todatetime(format_datetime(CreateDate, 'yyyy-MM-dd'))
| extend IsOutage = iif(isempty( IsOutage), false, IsOutage), IsOutageActual = iif(isempty( IsOutageActual), false, IsOutageActual), HasTsg = iif(isempty( HasTsg), 0, HasTsg), IsS360Related = iif(isempty( IsS360Related), 0, IsS360Related), IsAutoDetected = iif(isempty( IsAutoDetected), 0, IsAutoDetected)
| extend TTFix = iif(isempty( TTFix), 0, TTFix), TTEng = iif(isempty( TTEng), 0, TTEng), TTM = iif(isempty( TTM), 0, TTM)
| extend icmLink = strcat('https://portal.microsofticm.com/imp/v5/incidents/details/', tostring(IncidentId), '/summary')
| project IncidentId, Title, CreateDate, ModifiedDate, IncidentType, OwningTeamName = getSimpleTeamName(OwningTeamName), OwningTenantName, OwningContactAlias, RepairCount, RepairClosedCount, TTD, TTN, TTEng, TTFix, TTM, Severity, SubscriptionCount, IsAutoDetected, IsOutageActual, PostmortemTitle, PostmortemStatus, Status, HasTsg, Tags, IsS360Related, S360Link, icmLink
| join kind=leftouter
    hint.num_partitions=50 hint.strategy=shuffle (     cluster('https://icmcluster.kusto.windows.net').database('IcMDataWarehouse').IncidentCustomFieldEntries
    | where IncidentId in (ICMIDs) and TeamId in (XinyanTeamIds)
    | summarize hint.num_partitions=50 hint.strategy=shuffle arg_max(ModifiedDate, *) by IncidentId, Name
    | summarize hint.num_partitions=50 hint.strategy=shuffle       Category = max(iif(Name =~ 'IssueCategory', Value, ''))  by IncidentId
)
on IncidentId
| join kind=leftouter
    hint.num_partitions=50 hint.strategy=shuffle (     cluster('icmcluster').database('IcMDataWarehouse').IncidentsSnapshotV2
    | where IncidentId in (ICMIDs) and isempty( ParentIncidentId)
    | project IncidentId, RootCauseId, MonitorId, TsgId, OwningContactAlias
)
on IncidentId
| join kind=leftouter
    hint.num_partitions=50 hint.strategy=shuffle (     cluster('icmcluster').database('IcMDataWarehouse').RootCauses
    // find root cause
    | summarize arg_max(ModifiedDate, *) by RootCauseId
    | project RootCauseId, RCATitle = Title, RCADesscription = TrimHtmlContent(Description), IsCausedByChange
)
on RootCauseId
| join kind=leftouter
    hint.num_partitions=50 hint.strategy=shuffle (     cluster('icmcluster').database('IcMDataWarehouse').IncidentBugs
    // get work item
    | where IncidentId in (ICMIDs)
    | summarize arg_max(ModifiedDate, *) by IncidentId, ExternalId
    | summarize RepairItems = make_set(ExternalId) by IncidentId
    | project IncidentId, RepairItems
)
on IncidentId
| extend IsMissingRCA = iif (tolower(Status) != 'resolved', 0, iif(isempty(RootCauseId), 1, 0)), IncidentLink = getIncidentLink(IncidentId)
//| extend IncidentClass = case(     Title has "ApiUnexpectedFailures", 'CRPAPI',     Title has "NRPQos", 'NRPQosAPI',     Title has "[Qos] Server Side Error Rate High]","regionlevelQos",     Title has "LogicalDisk C FreeSpace Critical", "Disk",       Title has "WindowsFabricPartitionDown","PartitionDown",             Title has "PartitionQuorumLossDetectedInServiceFabric","PartitionDown",           Title has "DiagnosticsProd","DiagnosticsProd",   Title has  "port exhaustion","port",        Title has "MdmQos","MdmQos",     Title has "Aegis","Aegis",   Title has  "LVIDPercent_75","compact",      Title has "[ARM] requests to", "ARMAPI",     Title has "NRP PerfCounter", 'NRPCPU',     Title has "Explicit Locks","Locks",      Title has "Runner", "Runner",                Title has "[RunnerICM Aggregation CP", "Runner",      'Other'
// default value if neither condition is met
//)
| project IncidentId, Severity, IncidentLink, tostring(RepairItems), IsMissingRCA, IsOutageActual, RCATitle, RCADesscription, IsCausedByChange, Title, CreateDate, ModifiedDate, IncidentType, OwningTeamName, OwningTenantName, OwningContactAlias, RepairCount, RepairClosedCount, TTD, TTN, TTEng, TTFix, TTM, SubscriptionCount, IsAutoDetected, PostmortemTitle, PostmortemStatus, Status, HasTsg, IsS360Related,S360Link, Category, RootCauseId, MonitorId, TsgId
| join kind=leftouter hint.num_partitions=50 hint.strategy=shuffle (
    cluster('geneva').database('genevahealthconfigs').MonitorConfigSnapshot
    | where isnotempty( MonitorGuid)
    | summarize kind=leftouter hint.num_partitions=50 hint.strategy=shuffle arg_max(LastUpdateDate, MonitorGuid, monitor_name) by MonitorGuid
) on $left.MonitorId == $right.MonitorGuid
| extend IncidentClass = iif(isnotempty( monitor_name), monitor_name, iif(isnotempty( MonitorId), MonitorId, 'Other'))
| extend MonitorName = iif(IncidentClass != 'Other', IncidentClass, '')
| project IncidentId, Severity, IncidentLink, tostring(RepairItems), IsMissingRCA, IsOutageActual, RCATitle, RCADesscription, IsCausedByChange, Title, CreateDate, ModifiedDate, IncidentType, OwningTeamName, OwningTenantName, OwningContactAlias, RepairCount, RepairClosedCount, TTD, TTN, TTEng, TTFix, TTM, SubscriptionCount, IsAutoDetected, PostmortemTitle, PostmortemStatus, Status, HasTsg, IsS360Related,S360Link, Category, RootCauseId, TsgId, IncidentClass, MonitorId, MonitorName

  